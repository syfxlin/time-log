---
title: 线程状态和 ThreadLocal
date: 2020-12-10
categories:
  - Java
tags:
  - 概念
---

## 线程状态

- **新建（NEW）**：表示线程被创建出来还没真正启动的状态，可以认为它是个 Java 内部状态
- **就绪（RUNNABLE）**：表示该线程已经在 JVM 中执行，当然由于执行需要计算资源，它可能是正在运行，也可能还在等待系统分配给它 CPU 片段，在就绪队列里面排队
- **阻塞（BLOCKED）**：这个状态和我们前面两讲介绍的同步非常相关，阻塞表示线程在等待 Monitor lock。比如，线程试图通过 synchronized 去获取某个锁，但是其他线程已经独占了，那么当前线程就会处于阻塞状态
- **等待（WAITING）**：表示正在等待其他线程采取某些操作。一个常见的场景是类似生产者消费者模式，发现任务条件尚未满足，就让当前消费者线程等待（wait），另外的生产者线程去准备任务数据，然后通过类似 notify 等动作，通知消费线程可以继续工作了。Thread.join()也会令线程进入等待状态
- **计时等待（TIMED_WAIT）**：其进入条件和等待状态类似，但是调用的是存在超时条件的方法，比如 wait 或 join 等方法的指定超时版本
- **终止（TERMINATED）**：不管是意外退出还是正常执行结束，线程已经完成使命，终止运行，也有人把这个状态叫作死亡

状态切换：

![状态切换](https://cdn.jsdelivr.net/gh/syfxlin/pic/2020/12/20201210133731.png)

## ThreadLocal

ThreadLocal 是一种解决多线程环境下成员变量的问题的方案，但是与线程同步无关。其思路是为每一个线程创建一个单独的变量副本，从而每个线程都可以独立地改变自己所拥有的变量副本，而不会影响其他线程所对应的副本。

ThreadLocal 不是用于解决共享变量的问题的，也不是为了协调线程同步而存在，而是为了方便每个线程处理自己的状态而引入的一个机制。

四个方法：

- `get()`：返回此线程局部变量的当前线程副本中的值。
- `initialValue()`：返回此线程局部变量的当前线程的“初始值”。
- `remove()`：移除此线程局部变量当前线程的值。
- `set(T value)`：将此线程局部变量的当前线程副本中的值设置为指定值。

原理：

每个 Thread 内部都有一个 ThreadLocal.ThreadLocalMap 类型的成员变量，该成员变量用来存储实际的 ThreadLocal 变量副本。

ThreadLocalMap 提供了一种用键值对方式存储每一个线程的变量副本的方法，key 为当前 ThreadLocal 对象，value 则是对应线程的变量副本，是实现线程隔离机制的关键。

存储于 Thread 中的好处是可以在线程销毁的时候一并销毁 ThreadLocalMap，防止不能释放内存导致 OOM。

ThreadLocal 只是一个代理类，通过调用 ThreadLocal 的方法取得 ThreadLocalMap 里的变量副本，从而达到互不影响的效果。

内存泄漏：

需要注意的是 ThreadLocalMap 的 Key 是弱引用，但是 Value 是强引用，只有在线程结束时才会被回收。为了解决这个问题我们需要显示调用 remove()。
