---
title: HTTP - 数据压缩、分段传输、范围请求
date: 2020-09-25
categories:
  - HTTP
tags:
  - 概念
---

## 数据压缩

通常浏览器在发送请求的时候会带上 `Accept-Encoding` 头字段，服务器端就会采用支持的编码进行数据压缩，以提高加载速度。

数据压缩对文本文件有较好的压缩效果，因为文本文件中通常有很多相同的部分，如 HTML 的标签。但是对于已经编码压缩过的类型，如 mp4，mp3 等，压缩效果不明显，甚至可能会更差。

## 分段传输

分段传输指的是将传输的文件分解成多个小块分批发给浏览器，浏览器收到后再组装复原，这样就能提高文件传输的效率和可靠性。

响应报文使用 `Transfer-Encoding: chunked` 来设置使用分块传输，此时 `body` 中的内容就不是一次性发送的，而是会进行分块。

`Transfer-Encoding: chunked` 和 `Content-Length` 这两个字段是互斥的。

### 结构

![分段的结构](https://cdn.jsdelivr.net/gh/syfxlin/pic/2020/09/20200925202120.png)

每个分块包含两个部分，长度头和数据块。长度头是以 CRLF（回车换行，即 `\r\n`）结尾的一行明文，用 16 进制数字表示长度。数据块紧跟在长度头后，最后也用 `CRLF` 结尾，但数据不包含 `CRLF`。最后用一个长度为 0 的块表示结束，即 `0\r\n\r\n`

## 范围请求

支持范围请求的服务端可以按客户端的要求只传输文件中的指定范围，如看电影快进的时候，浏览器不会把快进前的内容都下载下来，而是直接请求指定的片段。

响应报文中添加 `Accept-Ranges: bytes` 来明确说明支持范围请求。请求报文通过 `Range: bytes=x-y` 来进行范围请求，支持负索引定位，如 -1 是文档的最后一个字节。

响应分段的时候响应报文需要添加 `Content-Range: bytes x-y/length` 表面响应的分段，同时要返回 `206 Partial Content` 的状态码
